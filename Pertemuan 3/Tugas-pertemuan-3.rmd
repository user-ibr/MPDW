---
title: "MPDW-Pertemuan-3"
author: "Ibrahim Zaidan"
date: "2025-09-15"
output: html_document
---

# Model regression with distributed lag
## Persiapan
```{r setup, message=FALSE, warning=FALSE}
packages <- c("dLagM", "forecast", "Metrics", "rio")
new.packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(dLagM)
library(forecast)
library(Metrics)
library(rio)

# Import data CSV kamu
data <- rio::import("C:/Users/De Ibrahim/kuliah/sem 5/NewDelhi_Air_quality.csv")

str(data)
n <- nrow(data)
train <- data[1:round(0.75*n), ]
test  <- data[(round(0.75*n)+1):n, ]

x_train <- as.numeric(train$pm10)
y_train <- as.numeric(train$AQI)

x_test  <- as.numeric(test$pm10)
y_test  <- as.numeric(test$AQI)
```

## Model DLM dasar (q=1)
```{r}
model.dlm1 <- dlm(x = x_train, y = y_train, q = 1)
summary(model.dlm1)

AIC(model.dlm1); BIC(model.dlm1)

fore.dlm1 <- dLagM::forecast(model = model.dlm1, x = x_test, h = length(y_test))

mape.dlm1 <- Metrics::mape(y_test, fore.dlm1$forecasts)
mape.dlm1

GoF(model.dlm1)
```
Adjusted RÂ² = 0.052 masih sangat rendah, Residual standard error = 2.117 cukup besar, F-statistic p = 0.098 tidak signifikan secara keseluruhan, dan AIC = 234.8 dan BIC = 242.7 relatif tinggi.

Artinya, Hubungan pm10 terhadap AQI belum terlihat kuat jika hanya memakai lag 1.
Hanya lag-1 yang signifikan, dan model secara keseluruhan belum fit baik.

## Menentukan lag optimum
```{r}
finiteDLMauto(
  formula = AQI ~ pm10,
  data = data.frame(train),
  q.min = 1, q.max = 10,
  model.type = "dlm",
  error.type = "AIC",
  trace = TRUE
)
```
Dari hasil tersebut, terlihat bahwa AIC paling kecil terdapat di q=10. Maka lag optimumnya adalah q=10

## Model DLM dengan lag optimum
```{r}
model.dlm.opt <- dlm(x = train$pm10, y = train$AQI, q = 10)
summary(model.dlm.opt)

AIC(model.dlm.opt); BIC(model.dlm.opt)

fore.dlm.opt <- dLagM::forecast(model = model.dlm.opt, x = x_test, h = length(y_test))
mape.dlm.opt <- Metrics::mape(y_test, fore.dlm.opt$forecasts)
mape.dlm.opt

GoF(model.dlm.opt)
```
Adjusted RÂ² = 0.3466 naik jauh dibanding model q=1

Residual standard error = 1.702 lebih kecil

F-statistic p = 0.0064 model signifikan secara keseluruhan

AIC = 183.7 dan BIC = 206.8 turun drastis dari model q=1

GoF = 0.1699 sedikit turun karena kompleksitas, tapi ini normal

Model ini menjelaskan variasi AQI lebih baik dan signifikan secara statistik dibanding ketika hanya menggunakan DLM dasar, hal ini menunjukkan bahwa pengaruh pm10 terhadap AQI bersifat tertunda (lagged effect) â€” butuh waktu beberapa periode sebelum dampaknya tampak pada kualitas udara.

# Model Autoregressive
## Mencari nilai p & q optimum
```{r}
library(dLagM)

data <- data[, c("AQI", "pm10")]

model.ardl.opt <- ardlBoundOrders(
  data = data,
  ic = "AIC",
  formula = AQI ~ pm10
)

min_p <- numeric(6)
for (i in 1:6) {
  min_p[i] <- min(model.ardl.opt$Stat.table[[i]], na.rm = TRUE)
}
q_opt <- which.min(min_p)
p_opt <- which.min(model.ardl.opt$Stat.table[[q_opt]])

data.frame(
  "q_optimum" = q_opt,
  "p_optimum" = p_opt,
  "AIC" = model.ardl.opt$min.Stat
)

set.seed(123)
n <- nrow(data)
train_size <- floor(0.8 * n)
train <- data[1:train_size, ]
test  <- data[(train_size+1):n, ]

model.ardl <- ardlDlm(
  formula = AQI ~ pm10,
  data = train,
  p = p_opt,
  q = q_opt
)

summary(model.ardl)
AIC(model.ardl)
```
Dapat dilihat bahwa q optimum yang didapat adalah 1 dan p optimum yang didapat adalah 13.

## Membangun model autoregressive manual & menghitung MAPE
```{r}
library(Metrics) 
library(dLagM)

coef <- coef(model.ardl$model)

y_last <- tail(train$AQI, 1)
x_lags <- rev(tail(train$pm10, 13))  

n_fore <- nrow(test)
y_forecast <- numeric(n_fore)

for (t in seq_len(n_fore)) {
  x_input <- c(test$pm10[t], x_lags) 
  y_pred <- coef["(Intercept)"] +
            sum(coef[grep("pm10", names(coef))] * x_input[1:14]) +
            coef["AQI.1"] * y_last
  y_forecast[t] <- y_pred
  
  y_last <- y_pred
  x_lags <- c(test$pm10[t], x_lags[1:13])
}

fore.ardl <- list(
  mean = y_forecast,
  actual = test$AQI
)

mape.ardl <- mean(abs((fore.ardl$actual - fore.ardl$mean) / fore.ardl$actual)) * 100
mape.ardl

GoF(model.ardl)
```
Model mampu menjelaskan sekitar 88â€“92% variasi AQI dengan residual error relatif kecil, dan evaluasi prediksi menunjukkan MAE â‰ˆ 0,46 serta MAPE â‰ˆ 17.266%.

# DLM (lag hingga 2) dengan Library dynlm
```{r}
library(dynlm)

y_train <- ts(y_train, frequency = 1)
x_train <- ts(x_train, frequency = 1)

train_data <- ts.union(y = y_train, x = x_train)

x_all <- ts(c(x_train, x_test), start = start(x_train), frequency = 1)
y_all <- ts(c(y_train, rep(NA, length(x_test))),
            start = start(y_train), frequency = 1)

all_data <- ts.union(y = y_all, x = x_all)

model.dlm.dynlm <- dynlm(y ~ L(x, 0:2), data = all_data)

full_pred_dlm <- fitted(model.dlm.dynlm)
fore.dlm <- tail(full_pred_dlm, length(x_test))

mape_dlm <- mean(abs((y_test - fore.dlm)/y_test)) * 100
mape_dlm
```
model DLM (Distributed Lag Model) dengan lag 0â€“2 dan menggunakan Library dynlm pada variabel x menghasilkan MAPE â‰ˆ 19,83%

# Model kocyk
```{r}
x_all <- ts(c(x_train, x_test))
y_all <- ts(c(y_train, rep(NA, length(y_test))))
all_data <- ts.union(y = y_all, x = x_all)

model.koyck <- dynlm(y ~ L(y,1) + x, data = all_data)

full_fitted <- fitted(model.koyck)
fore.koyck <- tail(full_fitted, length(y_test))

mape.koyck <- mean(abs((y_test - fore.koyck) / y_test)) * 100
mape.koyck
```
Hasil model Koyck menunjukkan MAPE â‰ˆ 15,62% pada data test

# ARDL(p=1, q=2) dengan Library dynlm
```{r}
library(dynlm)

x_all <- ts(c(x_train, x_test), start = start(x_train), frequency = 1)
y_all <- ts(c(y_train, rep(NA, length(x_test))),
            start = start(y_train), frequency = 1)

all_data <- ts.union(y = y_all, x = x_all)

fit.ardl.dynlm <- dynlm(y ~ L(y, 1) + L(x, 0:2), data = all_data)

full_pred <- fitted(fit.ardl.dynlm)
fore.ardl.dynlm <- tail(full_pred, length(x_test))

mape_ardl_dynlm <- mean(abs((y_test - fore.ardl.dynlm)/y_test))*100
mape_ardl_dynlm

```
Hasil model ARDL(p=1, q=2) menunjukkan MAPE â‰ˆ 15,52% pada data test

# Perbandingan model terbaik
```{r}
mape.dlm <- 16.99645       
mape.ardl <- 17.26622
mape.koyck <- 15.6177
mape_dlm <- 19.82978
mape_ardl_dynlm <- 15.5169

cat("ðŸ“Š HASIL PERBANDINGAN MAPE\n")
cat("MAPE Distributed Lag (dLagM):", mape.dlm, "\n")
cat("MAPE ARDL (dLagM):", mape.ardl, "\n")
cat("MAPE Koyck (dynlm):", mape.koyck, "\n")
cat("MAPE Distributed Lag (dynlm):", mape_dlm, "\n")
cat("MAPE ARDL (dynlm):", mape_ardl_dynlm, "\n")

```
Berdasarkan hasil perbandingan MAPE, dapat disimpulkan bahwa model ARDL dan Koyck yang memasukkan efek autoregresif dari AQI cenderung memberikan prediksi lebih akurat dibanding DLM murni dengan MAPE=15.5169 dan MAPE=15.6177
